<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/heads/compraCompleta :: compraCompleta}"></head>

<body data-theme="light">

<div class="app">

    <div th:replace="~{layout/sidebar :: sidebar}"></div>

    <div class="tasks-panel" id="tasksPanel">
    </div>

    <div class="main-content">
        <button type="button" class="volver" onclick="history.back()">
            <i data-feather="arrow-left"></i> Volver
        </button>

        <main class="compra-container">
            <h2 class="titulo-compra">üì¶ Registrar Compra</h2>

            <form id="formNuevaCompra">
                <input type="hidden" name="usuarioId" id="usuarioId" th:value="${currentUserId ?: 1}">

                <section class="form-grid">
                    <div class="form-group">
                        <label for="fechaCompra">Fecha y Hora</label>
                        <input type="datetime-local" id="fechaCompra" name="fecha"
                               th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd''T''HH:mm')}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="nombreProveedor">Proveedor</label>
                        <input type="text" id="nombreProveedor" name="nombreProveedor"
                               placeholder="Nombre del proveedor" required>
                    </div>
                    <div class="form-group">
                        <label for="marcaProveedor">Marca</label>
                        <input type="text" id="marcaProveedor" name="marca" placeholder="Marca del producto/MP"
                               required>
                    </div>

                    <div class="form-group">
                        <label for="tipoCompra">Tipo de Compra</label>
                        <select id="tipoCompra" name="tipo" required>
                            <option value="" selected>Selecciona el tipo</option>
                            <option value="MATERIA PRIMA">Materia Prima</option>
                            <option value="PRODUCTO TERMINADO">Producto Terminado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="telProveedor">Tel√©fono</label>
                        <input type="text" id="telProveedor" name="telProveedor" placeholder="Ej: 3001234567" required>
                    </div>
                    <div class="form-group">
                        <label for="emailProveedor">Email</label>
                        <input type="email" id="emailProveedor" name="emailProveedor"
                               placeholder="proveedor@ejemplo.com" required>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="estadoFactura">Estado de Factura</label>
                        <select id="estadoFactura" name="estadoCompra">
                            <option value="PENDIENTE" selected>PENDIENTE</option>
                            <option value="PAGADA">PAGADA</option>
                            <option value="CANCELADA">CANCELADA</option>
                        </select>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="descripcion">Descripci√≥n (opcional)</label>
                        <input id="descripcion" name="descripcion" type="text"
                               placeholder="Notas sobre la compra o factura">
                    </div>
                </section>
            </form>

            <section class="productos-card">
                <div class="productos-header">
                    <h3>Detalles de la Compra (<span id="tipoItemDisplay">No Seleccionado</span>)</h3>
                    <div>
                        <button type="button" id="btnAddItem" class="btn-azul" disabled
                                style="display: flex; align-items: center;">
                            <lord-icon src="https://cdn.lordicon.com/ueoydrft.json" trigger="hover" stroke="light"
                                       style="width:30px;height:30px"></lord-icon>
                            A√±adir √çtem
                        </button>
                    </div>
                </div>

                <div class="table-wrap">
                    <table class="tabla-productos">
                        <thead>
                        <tr>
                            <th style="width:120px">Tipo</th>
                            <th>Nombre</th>
                            <th style="width:120px">Cantidad</th>
                            <th style="width:140px">Precio Unitario</th>
                            <th style="width:140px">Subtotal</th>
                            <th style="width:90px">Acciones</th>
                        </tr>
                        </thead>
                        <tbody id="tablaItemsBody">
                        </tbody>
                    </table>
                </div>

                <div class="total-container">
                    <span class="total-label">TOTAL:</span>
                    <span id="totalGeneral" class="total-valor">0</span>
                    <input type="hidden" name="totalCompraHidden" id="totalCompraHidden" value="0">
                </div>
            </section>

            <div class="btn-guardar-container">
                <button id="btnGuardarCompra" class="btn-verde">‚úÖ Registrar Compra</button>
            </div>
        </main>

        <div id="modalMateriaPrima" class="modal hidden" aria-hidden="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Seleccionar Materia Prima</h3>
                    <button id="btnCerrarModalMP" class="btn-cerrar" aria-label="Cerrar">...</button>
                </div>
                <div class="modal-body">
                    <input type="text" id="buscarMateriaPrima" placeholder="Buscar MP por nombre..."
                           class="input-busqueda">
                    <div class="table-wrap">
                        <table class="tabla-productos">
                            <thead>
                            <tr>
                                <th>Nombre</th>
                                <th style="width:120px">Unidad</th>
                                <th style="width:120px">Precio Ref.</th>
                                <th style="width:120px">Stock Actual</th>
                                <th style="width:90px">Acci√≥n</th>
                            </tr>
                            </thead>
                            <tbody id="listaMateriaPrima">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="modalProductos" class="modal hidden" aria-hidden="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Seleccionar Producto Terminado</h3>
                    <button id="btnCerrarModalProd" class="btn-cerrar" aria-label="Cerrar">...</button>
                </div>
                <div class="modal-body">
                    <input type="text" id="buscarProducto" placeholder="Buscar producto por nombre..."
                           class="input-busqueda">
                    <div class="table-wrap">
                        <table class="tabla-productos">
                            <thead>
                            <tr>
                                <th>Nombre</th>
                                <th style="width:120px">Precio Venta</th>
                                <th style="width:120px">Stock Actual</th>
                                <th style="width:90px">Acci√≥n</th>
                            </tr>
                            </thead>
                            <tbody id="listaProductos">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    // Define las variables como propiedades del objeto global 'window'
    window.APP_URL = [[@{/}]];
    window.USER_ID = [[${currentUserId} ?: 1]];
    window.ROL_CLASIFICACION = [[${rolClasificacion} ?: 'EMPLEADO']];

    // Variables de Seguridad CSRF: Usa la inyecci√≥n directa de Thymeleaf
    window.CSRF_HEADER = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';
    window.CSRF_TOKEN = /*[[${_csrf.token}]]*/ 'token';
</script>

<script th:src="@{/js/compra/createCompraCompleta/compraCompleta.js}"></script>
<script th:src="@{/js/sidebar.js}"></script>
<script th:src="@{/js/dashboard.js}"></script>
<script th:src="@{/js/sweetalert2.all.min.js}"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</body>
</html>